{% extends "base.html" %} {% block content %}
<section class="relative flex min-h-dvh flex-col items-center justify-center">
  <div class="absolute h-full w-full overflow-hidden">
    <div
      class="bg-primary-15 absolute -top-[15vmin] -left-[15vmin] min-h-[75vmin] min-w-[75vmin] rounded-full"
    ></div>
    <div
      class="bg-primary-15 absolute -right-[15vmin] -bottom-[15vmin] min-h-[75vmin] min-w-[75vmin] rotate-45"
    ></div>
  </div>

  <img src="/static/logo.svg" class="mb-6 h-32 relative z-10" alt="QuizRush" />

  <!-- Password form -->
  <div
    id="auth-form"
    class="z-10 flex w-full max-w-80 flex-col gap-4 rounded-md bg-white p-4 shadow-sm"
  >
    <input
      id="password-input"
      type="password"
      class="rounded-sm p-2 text-lg font-semibold outline-2 outline-gray-300"
      placeholder="Manager password"
    />
    <button
      id="auth-btn"
      class="btn-shadow bg-primary rounded-md p-2 text-lg font-semibold text-white"
    >
      <span>Submit</span>
    </button>
  </div>

  <!-- Quiz selection (hidden initially) -->
  <div
    id="quiz-select"
    class="z-10 hidden w-full max-w-md flex-col gap-4 rounded-md bg-white p-4 shadow-sm"
  >
    <div class="flex flex-col items-center justify-center">
      <h1 class="mb-2 text-2xl font-bold">Select a quiz</h1>
      <div id="quiz-list" class="w-full space-y-2"></div>
    </div>
    <button
      id="create-btn"
      class="btn-shadow bg-primary rounded-md p-2 text-lg font-semibold text-white"
    >
      <span>Create Game</span>
    </button>
  </div>
</section>
{% endblock %} {% block scripts %}
<script>
  (function () {
    function getClientId() {
      let id = localStorage.getItem("quizrush_client_id");
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("quizrush_client_id", id);
      }
      return id;
    }

    const clientId = getClientId();
    const ws = QuizRush.connect(clientId);

    let selectedQuizId = null;

    ws.onmessage = function (e) {
      const msg = JSON.parse(e.data);

      switch (msg.type) {
        case "QuizList":
          document.getElementById("auth-form").classList.add("hidden");
          document.getElementById("quiz-select").classList.remove("hidden");
          document.getElementById("quiz-select").classList.add("flex");

          const list = document.getElementById("quiz-list");
          list.innerHTML = "";
          msg.quizzes.forEach(function (quiz) {
            const btn = document.createElement("button");
            btn.className =
              "flex w-full items-center justify-between rounded-md p-3 outline outline-gray-300";
            btn.innerHTML =
              quiz.subject +
              '<div class="quiz-radio h-5 w-5 rounded outline outline-offset-3 outline-gray-300"></div>';
            btn.onclick = function () {
              selectedQuizId = selectedQuizId === quiz.id ? null : quiz.id;
              document.querySelectorAll(".quiz-radio").forEach(function (r) {
                r.classList.remove("bg-primary", "shadow-inset");
              });
              if (selectedQuizId) {
                btn
                  .querySelector(".quiz-radio")
                  .classList.add("bg-primary", "shadow-inset");
              }
            };
            list.appendChild(btn);
          });
          break;

        case "GameCreated":
          window.location.href = "/game/" + msg.game_id + "?role=manager";
          break;

        case "ErrorMessage":
          QuizRush.toast(msg.message, "error");
          break;
      }
    };

    document.getElementById("auth-btn").onclick = function () {
      const password = document.getElementById("password-input").value;
      ws.send(JSON.stringify({ type: "ManagerAuth", password: password }));
    };

    document.getElementById("password-input").onkeydown = function (e) {
      if (e.key === "Enter") document.getElementById("auth-btn").click();
    };

    document.getElementById("create-btn").onclick = function () {
      if (!selectedQuizId) {
        QuizRush.toast("Please select a quiz", "error");
        return;
      }
      ws.send(JSON.stringify({ type: "CreateGame", quiz_id: selectedQuizId }));
    };
  })();
</script>
{% endblock %}
